<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° È´òÈÄüQR„Çπ„Ç≠„É£„Éä„Éº</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        #canvas {
            width: 100%;
            max-width: 480px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            background: #000;
            display: none;
        }
        
        #loadingMessage {
            padding: 30px;
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
            color: #1976d2;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 500;
        }
        
        .result-box {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .success {
            background: linear-gradient(45deg, #e8f5e9, #c8e6c9);
            color: #2e7d32;
            font-weight: bold;
            animation: pulse 1s ease-in-out;
        }
        
        .error {
            background: linear-gradient(45deg, #ffebee, #ffcdd2);
            color: #d32f2f;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .qr-data {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            border-left: 4px solid #4CAF50;
        }
        
        button {
            background: linear-gradient(45deg, #4285f4, #34a853);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        
        .scan-counter {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° È´òÈÄüQR„Çπ„Ç≠„É£„Éä„Éº</h1>
        
        <div id="loadingMessage">üé• „Ç´„É°„É©„ÇíËµ∑Âãï„Åó„Å¶„ÅÑ„Åæ„Åô...</div>
        <canvas id="canvas"></canvas>
        
        <div id="resultBox" class="result-box">
            <div id="resultMessage">QR„Ç≥„Éº„Éâ„Çí„Ç´„É°„É©„Å´Âêë„Åë„Å¶„Åè„Å†„Åï„ÅÑ</div>
            <div id="resultData"></div>
        </div>
        
        <div class="scan-counter">„Çπ„Ç≠„É£„É≥ÂõûÊï∞: <span id="scanCount">0</span></div>
        
        <button id="resetBtn" style="display:none;" onclick="resetScan()">
            Ê¨°„ÅÆQR„Çí„Çπ„Ç≠„É£„É≥
        </button>
    </div>

    <script>
        // ===============================================
        // ‚òÖ„Åì„Åì„Å´GAS„ÅÆWeb„Ç¢„Éó„É™URL„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyd_Q4YhhXuGBeJ1djaSewGt8sa-portaUJCqXZLLth_dY6CW3z2QqYDjC_Z_E0OZen/exec';
        // ===============================================
        
        const video = document.createElement("video");
        const canvasElement = document.getElementById("canvas");
        const canvas = canvasElement.getContext("2d");
        const loadingMessage = document.getElementById("loadingMessage");
        const resultBox = document.getElementById("resultBox");
        const resultMessage = document.getElementById("resultMessage");
        const resultData = document.getElementById("resultData");
        const resetBtn = document.getElementById("resetBtn");
        const scanCountElement = document.getElementById("scanCount");
        
        let isScanning = true;
        let scanCount = 0;
        let lastScannedData = null;
        let lastScanTime = 0;
        
        // „Ç´„É°„É©Ëµ∑Âãï
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: "environment",  // ËÉåÈù¢„Ç´„É°„É©ÂÑ™ÂÖà
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        }).then(function(stream) {
            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();
            requestAnimationFrame(scanLoop);
        }).catch(function(err) {
            loadingMessage.innerHTML = `‚ùå „Ç´„É°„É©„Ç®„É©„Éº: ${err.message}`;
            loadingMessage.style.background = 'linear-gradient(45deg, #ffebee, #ffcdd2)';
            loadingMessage.style.color = '#d32f2f';
        });
        
        // „É°„Ç§„É≥„Çπ„Ç≠„É£„É≥„É´„Éº„Éó
        function scanLoop() {
            if (!isScanning) return;
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // ÂàùÂõûË°®Á§∫Ë®≠ÂÆö
                if (loadingMessage.style.display !== 'none') {
                    loadingMessage.style.display = 'none';
                    canvasElement.style.display = 'block';
                    resultBox.style.display = 'block';
                }
                
                // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„ÇíÂãïÁîª„Å´Âêà„Çè„Åõ„Çã
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                
                // QR„Ç≥„Éº„ÉâËß£Êûê
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    // QR„Ç≥„Éº„ÉâÊ§úÂá∫Êû†„ÇíÊèèÁîª
                    drawDetectionFrame(code.location);
                    
                    // ÈáçË§á„Çπ„Ç≠„É£„É≥Èò≤Ê≠¢Ôºà1Áßí‰ª•ÂÜÖ„ÅÆÂêå„Åò„Éá„Éº„Çø„ÅØÁÑ°Ë¶ñÔºâ
                    const now = Date.now();
                    if (code.data !== lastScannedData || now - lastScanTime > 1000) {
                        lastScannedData = code.data;
                        lastScanTime = now;
                        handleQRDetected(code.data);
                    }
                }
            }
            
            if (isScanning) {
                requestAnimationFrame(scanLoop);
            }
        }
        
        // QR„Ç≥„Éº„ÉâÊ§úÂá∫Êû†„ÅÆÊèèÁîª
        function drawDetectionFrame(location) {
            canvas.beginPath();
            canvas.moveTo(location.topLeftCorner.x, location.topLeftCorner.y);
            canvas.lineTo(location.topRightCorner.x, location.topRightCorner.y);
            canvas.lineTo(location.bottomRightCorner.x, location.bottomRightCorner.y);
            canvas.lineTo(location.bottomLeftCorner.x, location.bottomLeftCorner.y);
            canvas.closePath();
            canvas.lineWidth = 4;
            canvas.strokeStyle = "#4CAF50";
            canvas.stroke();
        }
        
        // QR„Ç≥„Éº„ÉâÊ§úÂá∫Âá¶ÁêÜ
        async function handleQRDetected(qrData) {
            if (!isScanning) return;
            
            isScanning = false; // ÈÄ£Á∂öÊ§úÂá∫Èò≤Ê≠¢
            scanCount++;
            scanCountElement.textContent = scanCount;
            
            // Ê§úÂá∫Èü≥Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE=');
                audio.play();
            } catch (e) {
                // Èü≥Â£∞ÂÜçÁîüÂ§±Êïó„ÅØÁÑ°Ë¶ñ
            }
            
            // UIÊõ¥Êñ∞
            resultMessage.textContent = `‚úÖ QRÊ§úÂá∫ #${scanCount} - ÈÄÅ‰ø°‰∏≠...`;
            resultMessage.className = 'success';
            resultData.innerHTML = `<div class="qr-data">${escapeHtml(qrData)}</div>`;
            
            // GAS„Å∏ÈÄÅ‰ø°
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ 
                        qrData: qrData,
                        timestamp: new Date().toISOString(),
                        scanNumber: scanCount
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    resultMessage.textContent = `üéâ ‰øùÂ≠òÂÆå‰∫Ü #${scanCount}`;
                    resultData.innerHTML += `
                        <div style="background: #e8f5e9; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 12px;">
                            <strong>üìù „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà:</strong> Ë°å ${result.rowNumber} „Å´Ë®òÈå≤
                        </div>
                    `;
                    resetBtn.style.display = 'inline-block';
                } else {
                    throw new Error(result.message || 'GASÂÅ¥„Ç®„É©„Éº');
                }
                
            } catch (error) {
                console.error('ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
                resultMessage.textContent = `‚ùå ÈÄÅ‰ø°„Ç®„É©„Éº #${scanCount}`;
                resultMessage.className = 'error';
                resultData.innerHTML += `
                    <div style="background: #ffebee; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 12px; color: #d32f2f;">
                        <strong>„Ç®„É©„ÉºË©≥Á¥∞:</strong> ${error.message}
                    </div>
                `;
                // „Ç®„É©„ÉºÊôÇ„ÅØ3ÁßíÂæå„Å´Ëá™ÂãïÂÜçÈñã
                setTimeout(() => {
                    if (!isScanning) resetScan();
                }, 3000);
            }
        }
        
        // HTML„Ç®„Çπ„Ç±„Éº„Éó
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // „Çπ„Ç≠„É£„É≥„É™„Çª„ÉÉ„Éà
        function resetScan() {
            isScanning = true;
            resetBtn.style.display = 'none';
            resultMessage.textContent = 'QR„Ç≥„Éº„Éâ„Çí„Ç´„É°„É©„Å´Âêë„Åë„Å¶„Åè„Å†„Åï„ÅÑ';
            resultMessage.className = '';
            resultData.innerHTML = '';
            requestAnimationFrame(scanLoop);
        }
        
        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        window.addEventListener('beforeunload', () => {
            isScanning = false;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
